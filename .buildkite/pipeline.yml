# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json

steps:

  - label: "Trigger x-pack/packetbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - packetbeat/
                - x-pack/packetbeat/
                - .buildkite/x-pack/pipeline.xpack.packetbeat.yml
                - .buildkite/scripts/
                - .buildkite/hooks/
                # x-pack
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/
                - testing/
                - x-pack/libbeat/
              config:
                trigger: "beats-xpack-packetbeat"
                build:
                  commit: "${BUILDKITE_COMMIT}"
                  branch: "${BUILDKITE_BRANCH}"
                  env:
                    - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                    - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                    - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}


  - label: "Trigger Agentbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - auditbeat/
                - filebeat/
                - heartbeat/
                - metricbeat/
                - osquerybeat/
                - packetbeat/

                - x-pack/agentbeat/
                - x-pack/auditbeat/
                - x-pack/filebeat/
                - x-pack/heartbeat/
                - x-pack/metricbeat/
                - x-pack/osquerybeat/
                - x-pack/packetbeat/

                - .buildkite/x-pack/pipeline.xpack.agentbeat.yml
                - .buildkite/scripts/
                - .buildkite/hooks/
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/
                - testing/
              config:
                trigger: "beats-xpack-agentbeat"
                build:
                  commit: "${BUILDKITE_COMMIT}"
                  branch: "${BUILDKITE_BRANCH}"
                  env:
                    - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                    - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                    - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}
